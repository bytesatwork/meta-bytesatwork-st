From 8a123dbe874eec9ee999d5e8f06e71068565d8f1 Mon Sep 17 00:00:00 2001
From: Markus Kappeler <markus.kappeler@bytesatwork.ch>
Date: Wed, 21 Dec 2022 14:36:18 +0100
Subject: [PATCH] spi-nor: macronix: Use 2 lane bus and dual read

Macronix doesn't support quad spi, use dual instead.

Signed-off-by: Markus Kappeler <markus.kappeler@bytesatwork.ch>
---
 fdts/stm32mp15xx-byteengine.dtsi        | 2 +-
 plat/st/stm32mp1/stm32mp1_boot_device.c | 4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/fdts/stm32mp15xx-byteengine.dtsi b/fdts/stm32mp15xx-byteengine.dtsi
index cb173d101..cf565a4d3 100644
--- a/fdts/stm32mp15xx-byteengine.dtsi
+++ b/fdts/stm32mp15xx-byteengine.dtsi
@@ -59,7 +59,7 @@
 		reg = <0>;
 		spi-rx-bus-width = <2>;
 		spi-tx-bus-width = <2>;
-		spi-max-frequency = <10000000>;
+		spi-max-frequency = <50000000>;
 		#address-cells = <1>;
 		#size-cells = <1>;
 	};
diff --git a/plat/st/stm32mp1/stm32mp1_boot_device.c b/plat/st/stm32mp1/stm32mp1_boot_device.c
index 12aa1c2da..086da9ad4 100644
--- a/plat/st/stm32mp1/stm32mp1_boot_device.c
+++ b/plat/st/stm32mp1/stm32mp1_boot_device.c
@@ -197,13 +197,13 @@ int plat_get_nor_data(struct nor_device *device)
 	device->size = SZ_64M;
 
 	zeromem(&device->read_op, sizeof(struct spi_mem_op));
-	device->read_op.cmd.opcode = SPI_NOR_OP_READ_1_1_4;
+	device->read_op.cmd.opcode = SPI_NOR_OP_READ_1_1_2;
 	device->read_op.cmd.buswidth = SPI_MEM_BUSWIDTH_1_LINE;
 	device->read_op.addr.nbytes = 3U;
 	device->read_op.addr.buswidth = SPI_MEM_BUSWIDTH_1_LINE;
 	device->read_op.dummy.nbytes = 1U;
 	device->read_op.dummy.buswidth = SPI_MEM_BUSWIDTH_1_LINE;
-	device->read_op.data.buswidth = SPI_MEM_BUSWIDTH_4_LINE;
+	device->read_op.data.buswidth = SPI_MEM_BUSWIDTH_2_LINE;
 	device->read_op.data.dir = SPI_MEM_DATA_IN;
 
 	return 0;
-- 
2.39.2

